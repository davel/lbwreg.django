{% extends "registration/base.html" %}

{% block body %}
    <br/>
    {{ lbw.description }}
    <br/>
    <span class="lbw_start_time">
{% if lbw.timedelta > 0 %}
    Time since the LBW started: {{ lbw.start_date|timesince }}
    Time until the LBW ends: {{ lbw.end_date|timeuntil }}
{% else %}
    Time until the LBW starts: {{ lbw.start_date|timeuntil }}
{% endif %}
            </span>
    <br/>
    <br/>
    There are {{ lbw.adults }} registrations, totalling {{ lbw.adults }} adults and
    {{ lbw.children }} children registered.
    <br>
    <hr/>
    <br/>
    {% if user.is_authenticated %}
      <span style='font-weight: bold;'>Welcome, {{ user.first_name }}!</span>
      <br/>
      <br/>
      {% if user in lbw.owners.all %}
      <a href='{% url 'registration:update_lbw' lbw.id %}'>Update</a> the details of this LBW.<br/>
      <a href='{% url 'registration:delete_lbw' lbw.id %}'>Delete</a> this LBW.<br/>
      {% endif %}
      {% if user in lbw.attendees.all %}
        {% for user_reg in lbw.userregistration_set.all %}
          {% if user == user_reg.user %}
            <span style='font-weight: bold;'>You are expected here from {{ user_reg.arrival_date }} until {{ user_reg.departure_date }}.</span>
          <br/>
          If this is incorrect please update your registry entry below.<br/>
          <br/>
          {% if not user_reg.arrival_date or not user_reg.departure_date %}
            {% if not user_reg.arrival_date %}
              Arrival date unknown.<br/>
            {% endif %}
            {% if not user_reg.departure_date %}
              Departure date unknown.<br/>
            {% endif %}
              Please <a href='useredit.php'>update your registration
              records</a> so that we can schedule activities for maximum
              attendance<br/>
              Thank you<br/>
          {% endif %}
        {% endif %}
       {% endfor %}
      
      <table class='events'>
          <tr>
              <th colspan=5>
                  You are responsible for these <a href="{% url 'registration:activities' lbw.id %}">activities</a>
              </th>
          </tr>
          <tr>
              <th class='activity_name'>Title</th>
              <th class='activity_owner'>Organisers</th>
              <th class='activity_subs'>Subs.</th>
              <th class='activity_messages'>Msgs.</th>
              <th class='activity_schedule'>Schedule</th>
          </tr>
          {% for activity in lbw.activity.all %}
            {% if user in activity.owners.all %}
              {% include 'registration/activity_table_rows.html' %}
            {% endif %}
          {% endfor %}
      </table>
      <br/>
      <table class='events' border='1'>
          <TR>
              <TH COLSPAN=5>
              <span style='text-align: center;'>You are registered for these
                <a href="{% url 'registration:activities' lbw.id %}">activities</a></span>
              </th>
          </tr>
          <tr>
              <th class='activity_name'>Title</th>
              <th class='activity_owner'>Organisers</th>
              <th class='activity_subs'>Subs.</th>
              <th class='activity_messages'>Msgs.</th>
              <th class='activity_schedule'>Schedule</th>
          </tr>
          {% for activity in lbw.activity.all %}
            {% if user in activity.attendees.all %}
              {% include 'registration/activity_table_rows.html' %}
            {% endif %}
          {% endfor %}
      </table>
      {% endif %}
      <br/>
      {% with message_set=lbw.message_set %}
        {% include 'registration/message_table.html' %}
      {% endwith %}
      {% if user in lbw.attendees.all %}
      Current registration details:
      {% else %}
          We don't know if you're joining us this year. If you are coming please register below.
          <br>
      {% endif %}
      <form action="{% url 'registration:register' lbw.id %}" method="post">
        {% csrf_token %}
      <table>
        {{ user_registration_form.as_table }}
      </table>
        <input type="submit" value="{% if user in lbw.attendees.all %}Update{% else %}Register{% endif %}" />
      </form>
      {% if user in lbw.attendees.all %}
      <form action="{% url 'registration:deregister' lbw.id %}" method="post">
        {% csrf_token %}
        <input type="submit" value="Deregister" />
      </form>
      {% endif %}
      {% include "registration/message_write.html" %}
    {% endif %}
{% endblock %}
